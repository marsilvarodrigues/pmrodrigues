name: PMRodrigues Project Setup

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Docker Compose
      run: |
        sudo docker-compose -f infrastructure/docker-compose.yaml up -d
      working-directory: .

    - name: Set up Java
      uses: actions/setup-java@v2
      with:
        distribution: 'temurin'
        java-version: '18'

    - name: Build with Maven
      run: mvn clean package jacoco:report
      working-directory: .

    - name: Collect Junit Report
      run: |
        modules=( "common" "email-service" "security" "users-schema-modules" )
        for module in "${modules[@]}"; do
          cd "$module" || exit 1
          if [ -d "target/surefire-reports" ]; then
            echo "Processing module: ./$module/target/surefire-reports"     
            mkdir -p $GITHUB_WORKSPACE/surefire-reports/$module
            cp -r ./target/surefire-reports/* $GITHUB_WORKSPACE/surefire-reports/$module
          fi
          cd ..
        done
      working-directory: ${{ github.workspace }}


    - name: Workflow test
      steps:
      - uses: actions/checkout@v4
      - uses: ./
        with:
          artifact: test-results
          name: Workflow Report
          path: '**/surefire-reports.xml'
          reporter: java-junit

    - name: Stop Docker Compose
      run: |
        sudo docker-compose -f infrastructure/docker-compose.yaml down
      working-directory: .

    - name: Clean up Docker
      run: |
        docker system prune -af